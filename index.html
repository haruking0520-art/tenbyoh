<!DOCTYPE html>

<html>

<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Band Practice Mixer</title>

<style>

body { font-family: Arial; text-align:center; background:#111; color:white; }

.slider { width: 80%; margin:10px; }

.timeline { width:90%; margin-top:20px; }

button { padding:10px 20px; margin:10px; font-size:16px; border-radius:6px; border:none; cursor:pointer; }

.play { background:#28a745; color:white; }

.stop { background:#dc3545; color:white; }

</style>

</head>

<body>



<h2>ðŸŽ¸ Band Practice Mixer</h2>



<div>Drums<br><input class="slider" type="range" min="0" max="1" step="0.01" value="1" id="volDr"></div>

<div>Bass<br><input class="slider" type="range" min="0" max="1" step="0.01" value="1" id="volBa"></div>

<div>Guitar1<br><input class="slider" type="range" min="0" max="1" step="0.01" value="1" id="volGt1"></div>

<div>Guitar2<br><input class="slider" type="range" min="0" max="1" step="0.01" value="1" id="volGt2"></div>

<div>Piano<br><input class="slider" type="range" min="0" max="1" step="0.01" value="1" id="volPi"></div>

<div>Vocal1<br><input class="slider" type="range" min="0" max="1" step="0.01" value="1" id="volVo1"></div>

<div>Vocal2<br><input class="slider" type="range" min="0" max="1" step="0.01" value="1" id="volVo2"></div>



<input type="range" id="timeline" class="timeline" value="0" min="0" step="0.01">

<br>

<span id="timeDisplay">0:00</span>

<br>

<button class="play" id="btnPlay">â–¶ Play</button>

<button class="stop" id="btnStop">â–  Stop</button>



<script>

let context = null;
let buffers = {};
let gainNodes = {};
let sources = [];
let startTime = 0;
let pauseOffset = 0;
let isPlaying = false;
let timer = null;

const files = {
  dr: "Dr.mp3",
  ba: "Ba.mp3",
  gt1: "Gt1.mp3",
  gt2: "Gt2.mp3",
  pi: "Pi.mp3",
  vo1: "Vo1.mp3",
  vo2: "Vo2.mp3"
};

async function loadAudio() {
  if (!context) context = new (window.AudioContext || window.webkitAudioContext)();
  if (Object.keys(buffers).length > 0) return; // ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—

  console.log("Loading audio...");
  for (let key in files) {
    try {
      const response = await fetch(files[key]);
      const arrayBuffer = await response.arrayBuffer();
      buffers[key] = await context.decodeAudioData(arrayBuffer);

      const gainNode = context.createGain();
      gainNode.connect(context.destination);
      gainNodes[key] = gainNode;
    } catch (e) {
      console.error(`Failed to load ${files[key]}:`, e);
    }
  }
  document.getElementById("timeline").max = buffers.dr.duration;
}

async function playAll() {
  if (isPlaying) return; // äºŒé‡å†ç”Ÿé˜²æ­¢
  await loadAudio();
  await context.resume();

  sources = [];
  startTime = context.currentTime - pauseOffset;

  for (let key in buffers) {
    const src = context.createBufferSource();
    src.buffer = buffers[key];
    src.connect(gainNodes[key]);
    // pauseOffset ã®ä½ç½®ã‹ã‚‰å†ç”Ÿé–‹å§‹
    src.start(0, pauseOffset % buffers[key].duration);
    sources.push(src);
  }

  isPlaying = true;
  timer = setInterval(updateTimeline, 100);
}

function stopAll() {
  sources.forEach(s => { try { s.stop(); } catch(e) {} });
  sources = [];
  isPlaying = false;
  clearInterval(timer);
}

// åœæ­¢ãƒœã‚¿ãƒ³ï¼šå®Œå…¨ã«æœ€åˆã«æˆ»ã™
document.getElementById("btnStop").onclick = () => {
  stopAll();
  pauseOffset = 0;
  updateUI(0);
};

function updateTimeline() {
  if (!isPlaying) return;
  pauseOffset = context.currentTime - startTime;
  if (pauseOffset >= buffers.dr.duration) {
      stopAll();
      pauseOffset = 0;
  }
  updateUI(pauseOffset);
}

function updateUI(val) {
  document.getElementById("timeline").value = val;
  document.getElementById("timeDisplay").textContent = formatTime(val);
}

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ“ä½œ
document.getElementById("timeline").oninput = function() {
  const wasPlaying = isPlaying;
  stopAll();
  pauseOffset = parseFloat(this.value);
  updateUI(pauseOffset);
  if (wasPlaying) playAll(); // å†ç”Ÿä¸­ã ã£ãŸã‚‰ãã®å ´æ‰€ã‹ã‚‰å†é–‹
};

function formatTime(sec) {
  const m = Math.floor(sec/60);
  const s = Math.floor(sec%60).toString().padStart(2,"0");
  return m + ":" + s;
}

// ãƒœãƒªãƒ¥ãƒ¼ãƒ æ“ä½œï¼ˆåˆæœŸå€¤åæ˜ ç”¨ï¼‰
function setVol(key, val) {
  if (gainNodes[key]) gainNodes[key].gain.value = val;
}

document.getElementById("volDr").oninput = e => setVol('dr', e.target.value);
document.getElementById("volBa").oninput = e => setVol('ba', e.target.value);
document.getElementById("volGt1").oninput = e => setVol('gt1', e.target.value);
document.getElementById("volGt2").oninput = e => setVol('gt2', e.target.value);
document.getElementById("volPi").oninput = e => setVol('pi', e.target.value);
document.getElementById("volVo1").oninput = e => setVol('vo1', e.target.value);
document.getElementById("volVo2").oninput = e => setVol('vo2', e.target.value);

document.getElementById("btnPlay").onclick = playAll;
</script>

</body>

</html>