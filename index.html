let context = null;
let buffers = {};
let gainNodes = {};
let sources = [];
let startTime = 0;
let pauseOffset = 0;
let isPlaying = false;
let timer = null;

const files = {
  dr: "Dr.mp3",
  ba: "Ba.mp3",
  gt1: "Gt1.mp3",
  gt2: "Gt2.mp3",
  pi: "Pi.mp3",
  vo1: "Vo1.mp3",
  vo2: "Vo2.mp3"
};

async function loadAudio() {
  if (!context) context = new (window.AudioContext || window.webkitAudioContext)();
  if (Object.keys(buffers).length > 0) return; // ロード済みならスキップ

  console.log("Loading audio...");
  for (let key in files) {
    try {
      const response = await fetch(files[key]);
      const arrayBuffer = await response.arrayBuffer();
      buffers[key] = await context.decodeAudioData(arrayBuffer);

      const gainNode = context.createGain();
      gainNode.connect(context.destination);
      gainNodes[key] = gainNode;
    } catch (e) {
      console.error(`Failed to load ${files[key]}:`, e);
    }
  }
  document.getElementById("timeline").max = buffers.dr.duration;
}

async function playAll() {
  if (isPlaying) return; // 二重再生防止
  await loadAudio();
  await context.resume();

  sources = [];
  startTime = context.currentTime - pauseOffset;

  for (let key in buffers) {
    const src = context.createBufferSource();
    src.buffer = buffers[key];
    src.connect(gainNodes[key]);
    // pauseOffset の位置から再生開始
    src.start(0, pauseOffset % buffers[key].duration);
    sources.push(src);
  }

  isPlaying = true;
  timer = setInterval(updateTimeline, 100);
}

function stopAll() {
  sources.forEach(s => { try { s.stop(); } catch(e) {} });
  sources = [];
  isPlaying = false;
  clearInterval(timer);
}

// 停止ボタン：完全に最初に戻す
document.getElementById("btnStop").onclick = () => {
  stopAll();
  pauseOffset = 0;
  updateUI(0);
};

function updateTimeline() {
  if (!isPlaying) return;
  pauseOffset = context.currentTime - startTime;
  if (pauseOffset >= buffers.dr.duration) {
      stopAll();
      pauseOffset = 0;
  }
  updateUI(pauseOffset);
}

function updateUI(val) {
  document.getElementById("timeline").value = val;
  document.getElementById("timeDisplay").textContent = formatTime(val);
}

// タイムライン操作
document.getElementById("timeline").oninput = function() {
  const wasPlaying = isPlaying;
  stopAll();
  pauseOffset = parseFloat(this.value);
  updateUI(pauseOffset);
  if (wasPlaying) playAll(); // 再生中だったらその場所から再開
};

function formatTime(sec) {
  const m = Math.floor(sec/60);
  const s = Math.floor(sec%60).toString().padStart(2,"0");
  return m + ":" + s;
}

// ボリューム操作（初期値反映用）
function setVol(key, val) {
  if (gainNodes[key]) gainNodes[key].gain.value = val;
}

document.getElementById("volDr").oninput = e => setVol('dr', e.target.value);
document.getElementById("volBa").oninput = e => setVol('ba', e.target.value);
document.getElementById("volGt1").oninput = e => setVol('gt1', e.target.value);
document.getElementById("volGt2").oninput = e => setVol('gt2', e.target.value);
document.getElementById("volPi").oninput = e => setVol('pi', e.target.value);
document.getElementById("volVo1").oninput = e => setVol('vo1', e.target.value);
document.getElementById("volVo2").oninput = e => setVol('vo2', e.target.value);

document.getElementById("btnPlay").onclick = playAll;